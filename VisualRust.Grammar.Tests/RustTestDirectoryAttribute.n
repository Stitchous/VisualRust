using Nemerle.Xml;
using Nemerle.Linq;
using System;
using System.IO;
using System.Linq;

namespace VisualRust.Grammar.Tests
{
    [AttributeUsage(AttributeTargets.Method, AllowMultiple = false)]
    class RustTestDirectoryAttribute : System.Attribute
    {
        public this(path : string, file : string)
        {
            this(path, file, "")
        }
        
        public this(path : string, file : string, excludepath : string)
        {
            def dir = AppDomain.CurrentDomain.BaseDirectory;
             
            def files = Directory.EnumerateFiles(Path.GetFullPath(Path.Combine(dir, path)), "*.rs", SearchOption.AllDirectories);
            def filteredFiles = files.Where(file => !excludepath.Any() || file.IndexOf(Path.GetFullPath(excludepath), StringComparison.OrdinalIgnoreCase) == -1);
            
            def testData = xml <# 
                <TestData>
                        <Filename $foreach (file in filteredFiles)>$(file)</Filename>
                </TestData>
            #>;

            File.WriteAllText(file, testData.ToString());
        }
    }
}
